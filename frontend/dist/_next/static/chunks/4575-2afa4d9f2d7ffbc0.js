"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4575],{1398:(e,t,s)=>{s.d(t,{z:()=>a});var r=s(7214);class a{static handle(e){if(e.success)return null;let{error:t}=e;return t?this.mapErrorCodeToAppError(t.code,t.message,t.details):{type:r.B.SYSTEM,code:"UNKNOWN_ERROR",message:"알 수 없는 오류가 발생했습니다.",recoverable:!1}}static handleNetworkError(e){return navigator.onLine?e&&"object"==typeof e&&"code"in e&&"ECONNABORTED"===e.code||e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message&&e.message.includes("timeout")?{type:r.B.NETWORK,code:"REQUEST_TIMEOUT",message:"요청 시간이 초과되었습니다. 다시 시도해주세요.",recoverable:!0}:{type:r.B.NETWORK,code:"NETWORK_ERROR",message:"네트워크 연결을 확인해주세요.",recoverable:!0}:{type:r.B.NETWORK,code:"NETWORK_OFFLINE",message:"인터넷 연결을 확인해주세요.",recoverable:!0}}static mapErrorCodeToAppError(e,t,s){switch(e){case"USER_NOT_FOUND":case"INVALID_PASSWORD":return{type:r.B.AUTHENTICATION,code:e,message:t,field:"credentials",recoverable:!0};case"PRINCIPAL_NOT_FOUND":case"TEACHER_NOT_FOUND":case"STUDENT_NOT_FOUND":return{type:r.B.AUTHENTICATION,code:e,message:t,recoverable:!1};case"TOKEN_EXPIRED":case"INVALID_TOKEN":return{type:r.B.AUTHENTICATION,code:e,message:t,recoverable:!1,action:()=>{localStorage.removeItem("session"),window.location.href="/auth"}};case"INSUFFICIENT_PERMISSIONS":case"FORBIDDEN":return{type:r.B.AUTHORIZATION,code:e,message:t,recoverable:!1};case"VALIDATION_ERROR":return{type:r.B.VALIDATION,code:e,message:t,fieldErrors:this.extractFieldErrors(s),recoverable:!0};case"USER_ID_ALREADY_EXISTS":return{type:r.B.VALIDATION,code:e,message:t,field:"userId",recoverable:!0};case"CLASS_FULL":case"ENROLLMENT_EXISTS":case"REFUND_REQUEST_EXISTS":case"ALREADY_ENROLLED":case"SESSION_FULL":case"SESSION_ALREADY_STARTED":case"SESSION_ALREADY_PASSED":case"ACADEMY_CODE_ALREADY_EXISTS":case"ACADEMY_CODE_NOT_FOUND":case"STUDENT_ALREADY_JOINED":case"STUDENT_NOT_JOINED":case"TEACHER_NOT_FOUND":case"STUDENT_NOT_FOUND":case"PRINCIPAL_NOT_FOUND":case"CLASS_NOT_FOUND":case"SESSION_NOT_FOUND":case"BALLET_POSE_NOT_FOUND":case"SESSION_CONTENT_NOT_FOUND":case"REFUND_REQUEST_ALREADY_EXISTS":case"REFUND_REQUEST_NOT_FOUND":case"REJECTION_DETAIL_ALREADY_EXISTS":case"REJECTION_DETAIL_NOT_FOUND":case"CONFLICT":return{type:r.B.BUSINESS,code:e,message:t,recoverable:!0};case"NOT_FOUND":return{type:r.B.BUSINESS,code:e,message:t,recoverable:!1};case"INTERNAL_SERVER_ERROR":case"DATABASE_ERROR":return{type:r.B.SYSTEM,code:e,message:"서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.",recoverable:!0};default:return{type:r.B.SYSTEM,code:e,message:t,recoverable:!0}}}static extractFieldErrors(e){return e&&"object"==typeof e&&Array.isArray(e.fieldErrors)?e.fieldErrors.map(e=>({field:e&&"object"==typeof e&&"field"in e&&"string"==typeof e.field?e.field:"",message:e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message?e.message:"",value:e&&"object"==typeof e&&"value"in e?e.value:void 0})):[]}static getUserFriendlyMessage(e){return({USER_NOT_FOUND:"아이디 또는 비밀번호가 올바르지 않습니다.",INVALID_PASSWORD:"아이디 또는 비밀번호가 올바르지 않습니다.",USER_ID_ALREADY_EXISTS:"이미 사용 중인 아이디입니다.",TOKEN_EXPIRED:"로그인이 만료되었습니다. 다시 로그인해주세요.",INSUFFICIENT_PERMISSIONS:"이 작업을 수행할 권한이 없습니다.",CLASS_FULL:"수강 인원이 초과되었습니다.",ENROLLMENT_EXISTS:"이미 수강 신청한 클래스입니다.",NETWORK_OFFLINE:"인터넷 연결을 확인해주세요.",REQUEST_TIMEOUT:"요청 시간이 초과되었습니다. 다시 시도해주세요."})[e.code]||e.message}}},2313:(e,t,s)=>{s.d(t,{Xq:()=>T,yH:()=>I,Jt:()=>N,bE:()=>S,yJ:()=>h});var r=s(5125),a=s(4575);function i(e){var t;return!(!e||!(null==(t=e.user)?void 0:t.id)||!e.accessToken||e.expiresAt&&e.expiresAt<Date.now())}function o(e){return(null==e?void 0:e.expiresAt)?Math.max(0,e.expiresAt-Date.now()):0}function n(e){return{session:e,isLoading:!1,error:null,isAuthenticated:i(e),user:(null==e?void 0:e.user)||null,accessToken:null==e?void 0:e.accessToken,timeUntilExpiry:o(e),isTokenExpiringSoon:function(e){let t=o(e);return t>0&&t<3e5}(e)}}class c{getViewModel(){return this.viewModel}async fetchSession(){let e=Date.now();if(this.cache&&e-this.cacheTime<this.CACHE_DURATION)return this.viewModel=this.cache,this.viewModel;this.viewModel.isLoading=!0,this.viewModel.error=null;try{let s=await (0,a.Ht)();if(null==s?void 0:s.data){var t;let r={user:{id:(t=s.data).user.id.toString(),name:t.user.name,role:t.user.role,email:void 0},accessToken:t.accessToken,error:void 0,expiresAt:t.expiresAt};this.viewModel=n(r),this.cache=this.viewModel,this.cacheTime=e}else this.viewModel=n(null)}catch(t){let e=t instanceof Error?t.message:"세션 조회 실패";this.viewModel={...this.viewModel,session:null,isLoading:!1,error:e,isAuthenticated:!1,user:null,accessToken:void 0,timeUntilExpiry:0,isTokenExpiringSoon:!1}}finally{this.viewModel.isLoading=!1}return this.viewModel}updateSession(e){if(!this.viewModel.session)return;let t={...this.viewModel.session,...e,user:{...this.viewModel.session.user,...e.user}};this.viewModel=n(t),this.cache&&(this.cache=this.viewModel)}clearSession(){this.viewModel=n(null),this.cache=null,this.cacheTime=0}invalidateCache(){this.cache=null,this.cacheTime=0}validateSession(){return i(this.viewModel.session)}needsTokenRefresh(){return this.viewModel.isTokenExpiringSoon}getSessionInfo(){var e,t,s;return{isAuthenticated:this.viewModel.isAuthenticated,userId:null==(e=this.viewModel.user)?void 0:e.id,userName:null==(t=this.viewModel.user)?void 0:t.name,userRole:null==(s=this.viewModel.user)?void 0:s.role,hasToken:!!this.viewModel.accessToken,timeUntilExpiry:this.viewModel.timeUntilExpiry,isExpiringSoon:this.viewModel.isTokenExpiringSoon}}constructor(){this.cache=null,this.cacheTime=0,this.CACHE_DURATION=3e5,this.viewModel={session:null,isLoading:!1,error:null,isAuthenticated:!1,user:null,accessToken:void 0,timeUntilExpiry:0,isTokenExpiringSoon:!1}}}var l=s(1398);let u=r.A.create({baseURL:"http://localhost:3001",withCredentials:!0,headers:{"Content-Type":"application/json"}}),d=new c,E=async()=>{try{let{SessionManager:e}=await Promise.resolve().then(s.bind(s,4582));return e.get()}catch(e){return null}},T=()=>{d.clearSession()};u.interceptors.request.use(async e=>{var t,s;if((null==(t=e.url)?void 0:t.includes("/auth/session"))||(null==(s=e.url)?void 0:s.includes("/auth/verify")))return e;let r=await E();return(null==r?void 0:r.accessToken)&&e.headers&&(e.headers.Authorization="Bearer ".concat(r.accessToken)),e},e=>Promise.reject(e)),u.interceptors.response.use(e=>e,e=>{var t;if(null==(t=e.response)?void 0:t.data){let t=e.response.data,s=l.z.handle(t);if(s)return"AUTHENTICATION"===s.type&&["TOKEN_EXPIRED","INVALID_TOKEN"].includes(s.code)&&s.action&&s.action(),Promise.reject(s)}return Promise.reject(l.z.handleNetworkError(e))});let N=(e,t)=>u.get(e,t).then(e=>e.data),S=(e,t,s)=>u.post(e,t,s).then(e=>e.data),h=(e,t,s)=>u.put(e,t,s).then(e=>e.data),I=(e,t)=>u.delete(e,t).then(e=>e.data)},4575:(e,t,s)=>{s.d(t,{$5:()=>c,Be:()=>o,Ht:()=>l,Tn:()=>n,iD:()=>a,ri:()=>i});var r=s(2313);let a=e=>(0,r.bE)("/auth/login",e),i=()=>(0,r.bE)("/auth/logout"),o=e=>(0,r.bE)("/auth/refresh",e),n=e=>(0,r.bE)("/auth/check-userid",e),c=e=>(0,r.bE)("/auth/signup",e),l=()=>(0,r.Jt)("/auth/session")},4582:(e,t,s)=>{s.d(t,{CP:()=>l,Ht:()=>T,Rt:()=>E,SessionManager:()=>c,go:()=>d,wV:()=>u});var r=s(5155),a=s(2115),i=s(4575);let o=(0,a.createContext)({data:null,status:"unauthenticated",update:async()=>{},signIn:async()=>({ok:!1,error:"Not initialized"}),signOut:async()=>{}}),n={get:()=>localStorage.getItem("accessToken"),set:e=>{localStorage.setItem("accessToken",e)},remove:()=>{localStorage.removeItem("accessToken"),localStorage.removeItem("next-auth.session-token"),localStorage.removeItem("next-auth.csrf-token")}},c={get:()=>{try{let e=localStorage.getItem("session");return e?JSON.parse(e):null}catch(e){return null}},set:e=>{localStorage.setItem("session",JSON.stringify(e))},remove:()=>{localStorage.removeItem("session")}},l=e=>{let{children:t,session:s}=e,[l,u]=(0,a.useState)(s||null),[d,E]=(0,a.useState)(!s);(0,a.useEffect)(()=>{if(s)return void E(!1);(async()=>{try{let e=c.get(),t=n.get();if(e&&t)if(e.expiresAt&&e.expiresAt>Date.now())u(e);else try{let t=await (0,i.Be)({userId:e.user.id});if(t.data){let s={user:e.user,accessToken:t.data.access_token,expiresAt:Date.now()+1e3*t.data.expires_in,error:void 0};c.set(s),s.accessToken&&n.set(s.accessToken),u(s)}}catch(e){c.remove(),n.remove(),u(null)}}catch(e){u(null)}finally{E(!1)}})()},[s]);let T=(0,a.useCallback)(async(e,t)=>{if("credentials"!==e||!t)throw Error("Unsupported provider");try{E(!0);let e=await (0,i.iD)({userId:t.userId,password:t.password});if(e.data){let t={user:{id:e.data.user.id.toString(),name:e.data.user.name,role:e.data.user.role,email:void 0},accessToken:e.data.access_token,expiresAt:Date.now()+72e5};return c.set(t),t.accessToken&&n.set(t.accessToken),u(t),{ok:!0,error:null}}return{ok:!1,error:"로그인 실패"}}catch(e){return{ok:!1,error:e instanceof Error?e.message:"로그인 실패"}}finally{E(!1)}},[]),N=(0,a.useCallback)(async e=>{try{await (0,i.ri)()}catch(e){}finally{c.remove(),n.remove(),u(null)}},[]),S=(0,a.useCallback)(async e=>{if(l&&e){let t={...l,...e};c.set(t),u(t)}},[l]);return(0,a.useEffect)(()=>{if(!l)return;let e=setInterval(async()=>{let e=Date.now(),t=(l.expiresAt||0)-e;if(l.expiresAt&&t<3e5&&t>0)try{let e=await (0,i.Be)({userId:l.user.id});if(e.data){let t={...l,accessToken:e.data.access_token,expiresAt:Date.now()+1e3*e.data.expires_in,error:void 0};c.set(t),t.accessToken&&n.set(t.accessToken),u(t)}}catch(e){u({...l,error:"RefreshAccessTokenError",accessToken:void 0})}},6e4);return()=>clearInterval(e)},[l]),(0,r.jsx)(o.Provider,{value:{data:l,status:d?"loading":l?"authenticated":"unauthenticated",update:S,signIn:T,signOut:N},children:t})},u=()=>{let e=(0,a.useContext)(o);if(!e)throw Error("useSession must be used within a SessionProvider");return{data:e.data,status:e.status,update:e.update}},d=()=>{let{signIn:e}=(0,a.useContext)(o);return e},E=()=>{let{signOut:e}=(0,a.useContext)(o);return e},T=async()=>{try{let e=c.get();if(null==e?void 0:e.accessToken)return e;return(await (0,i.Ht)()).data}catch(e){return null}}},7214:(e,t,s)=>{s.d(t,{B:()=>r});var r=function(e){return e.AUTHENTICATION="AUTHENTICATION",e.AUTHORIZATION="AUTHORIZATION",e.VALIDATION="VALIDATION",e.BUSINESS="BUSINESS",e.NETWORK="NETWORK",e.SYSTEM="SYSTEM",e}({})}}]);